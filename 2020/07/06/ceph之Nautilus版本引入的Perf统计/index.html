<!DOCTYPE html>
<html>
<head>
    

    

    



    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    
    
    
    
    <title>ceph之Nautilus版本引入的Perf统计 | 行路中. | 脚踏实地</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="源码,ceph,rbd,perf">
    <meta name="description" content="背景 Nautilus在OSD和MGR中合并了通用的度量收集框架，以提供内置的监视，并且在该框架之上构建了新的RBD性能监视工具，以将各个RADOS对象度量转换为针对IOPS，吞吐量和性能的聚合RBD镜像度量。这些指标都是在Ceph集群本身内部生成和处理的，因此无需访问客户端节点即可获取指标。 源码阅读过程 新增接口 12rbd perf image iostat rbd perf image i">
<meta property="og:type" content="article">
<meta property="og:title" content="ceph之Nautilus版本引入的Perf统计">
<meta property="og:url" content="https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/index.html">
<meta property="og:site_name" content="行路中.">
<meta property="og:description" content="背景 Nautilus在OSD和MGR中合并了通用的度量收集框架，以提供内置的监视，并且在该框架之上构建了新的RBD性能监视工具，以将各个RADOS对象度量转换为针对IOPS，吞吐量和性能的聚合RBD镜像度量。这些指标都是在Ceph集群本身内部生成和处理的，因此无需访问客户端节点即可获取指标。 源码阅读过程 新增接口 12rbd perf image iostat rbd perf image i">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-05T16:15:48.000Z">
<meta property="article:modified_time" content="2023-03-18T15:11:14.895Z">
<meta property="article:author" content="Sean10">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="rbd">
<meta property="article:tag" content="perf">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" type="application/atom+xml" title="行路中." href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 6.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Sean10</h5>
          <a href="mailto:sean10reborn@gmail.com" title="sean10reborn@gmail.com" class="mail">sean10reborn@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/sean10" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">ceph之Nautilus版本引入的Perf统计</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">ceph之Nautilus版本引入的Perf统计</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-07-05T16:15:48.000Z" itemprop="datePublished" class="page-time">
  2020-07-06
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pro/">专业</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%83%8C%E6%99%AF"><span class="post-toc-number">1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E8%BF%87%E7%A8%8B"><span class="post-toc-number">2.</span> <span class="post-toc-text">源码阅读过程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%96%B0%E5%A2%9E%E6%8E%A5%E5%8F%A3"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">新增接口</span></a></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-ceph之Nautilus版本引入的Perf统计"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">ceph之Nautilus版本引入的Perf统计</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-07-06 00:15:48" datetime="2020-07-05T16:15:48.000Z"  itemprop="datePublished">2020-07-06</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pro/">专业</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="背景">背景</h2>
<p>Nautilus在OSD和MGR中合并了通用的度量收集框架，以提供内置的监视，并且在该框架之上构建了新的RBD性能监视工具，以将各个RADOS对象度量转换为针对IOPS，吞吐量和性能的聚合RBD镜像度量。这些指标都是在Ceph集群本身内部生成和处理的，因此无需访问客户端节点即可获取指标。</p>
<h2 id="源码阅读过程">源码阅读过程</h2>
<h3 id="新增接口">新增接口</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rbd perf image iostat </span><br><span class="line">rbd perf image iotop</span><br></pre></td></tr></table></figure>
<p>根据这里<a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/master/releases/nautilus/">v14.2.9
Nautilus — Ceph Documentation</a></p>
<blockquote>
<p>New rbd perf image iotop and rbd perf image iostat commands provide
an iotop- and iostat-like IO monitor for all RBD images.</p>
</blockquote>
<blockquote>
<p>The ceph-mgr Prometheus exporter now optionally includes an IO
monitor for all RBD images.</p>
</blockquote>
<p>应该是在14.2.0的发布里完成的，那这次大版本包含了什么？小版本更新会包含pr和issue链接</p>
<p>14版本还增加了ceph config全局配置修改的功能。</p>
<p>ceph14支持pg数减小和pg数根据pool容量自动调整 ceph telemetry命令用ceph
mgr module enable telemetry启用，但是对telemetry不了解也跳过了。
这个应该就是我要看到的openTelemetry</p>
<p><a target="_blank" rel="noopener" href="https://ceph.io/releases/v12-2-13-luminous-released/">Ceph
v12.2.13 Luminous released - Ceph</a></p>
<p>这个应该是12版本最后一次补丁升级吧</p>
<p>这个里不包含大版本开发的代码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/26133/files">rbd:
implement new 'rbd perf image iostat/iotop' commands by dillaman · Pull
Request #26133 · ceph/ceph</a></p>
<p>就这个提交来看，大部分代码都在处理上下文的接口适配,增加选项，假如说这套代码里只是使用已经增加的接口，那么代码里就应该有调用的API</p>
<p>这个问题怎么才能验证?</p>
<p><code>src/toos/rbd/action/Perf.cc</code>这个新增文件，依赖的是rbd
perf image stats。</p>
<p>然后<code>rbd perf image stats</code>也是这次commit里增加的，是继承MgrModule使用API实现的，看看这里面用的哪些api.</p>
<p>应该就是这里拿的了</p>
<p><code>register_osd_perf_queries</code>好像有点像了。</p>
<p>这里使用了mgr_module.py提供的add_osd_perf_query</p>
<p>从这里拿到了osd层面的ops,write_ops, read_ops, bytes, write_bytes,
latency这些内容</p>
<p>拿到osd的结果，怎么计算出rbd层的？</p>
<p>他这里只查appplication_metadata里有rbd这个的资源池，然后拿到资源池的osd_map</p>
<p>user_query变量里，QUERY_POOL_ID_MAP拿到了</p>
<p>在PerfHandler里进行的周期查询perf数据。</p>
<p>在这里周期获取数据时又调用了mgr-module的get_osd_perf_counters。emm，这个函数在12版本我们的代码里还没有，不过单论这部分呼出，其实我们可以。这个函数在14版本里，prometheus也调用了这个，那就有意思了，prometheus刚好在这个版本支持了rbd
performance monitor,
ceph-export输出了这部分数据。那是不是就是从这里拿到的呢？（osd_perf_query_support</p>
<p>在这里ceph-mgr里面的_ceph_get_osd_perf_counters的内容。这个函数就是Cython的封装了。</p>
<p>get_osd_perf_counters这个封装，好像还是在ceph-mgr里提供的，果然。</p>
<p>在ActivePyModules.cc里又封装了一层，这里应该是从DaemonServer.cc里封装的实际逻辑了。</p>
<p>果然，在ActivePyModules里实例化了DaemonServer这个对象，</p>
<p>这里调用osd_perf_metric_collector的get_counters。OSDPerfMetricCollector这个类，应该是12版本之后给mgr好好梳理时更新出来的。</p>
<p>在OSDPerfMetricSubKeyDescriptor这个struct里，封装了支持的类型</p>
<p>卧槽，好像这里全覆盖了,在下面这里做的扩充。从Client，牛皮</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/25371/files">osd: support
more dynamic perf query subkey types by trociny · Pull Request #25371 ·
ceph/ceph</a></p>
<p>那<code>OSDPerfMetricCollector</code>呢，是在这个PR里增加的？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/24117">mgr: create shell
OSD performance query class by trociny · Pull Request #24117 ·
ceph/ceph</a></p>
<p>在下面这里提到了，开启这个收集功能之后，这套功能会遇到rbd
images数据过于庞大的问题，</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/24265">osd: collect client
perf stats when query is enabled by trociny · Pull Request #24265 ·
ceph/ceph</a></p>
<p>再在这个类下面继续探究就有点难的感觉了。下面就越来越细，估计需要实机环境验证了。</p>
<p>Prior to Red Hat Storage 4, Ceph storage administrators have not had
access to built-in RBD performance monitoring and metrics gathering
tools.</p>
<p>Ceph Storage 4 now incorporates a generic metrics gathering framework
within the OSDs and MGRs to provide built-in monitoring, and new RBD
performance monitoring tools are built on top of this framework to
translate individual RADOS object metrics into aggregated RBD image
metrics for Input/Output Operations per Second (IOPS), throughput, and
latency.</p>
<p>好像在这篇文章里要解释到底是怎么计算的了。哦，没解释</p>
<p>eph ceph mgr module enable rbd_support</p>
<p>Noisy Neighbors and QoS看到好几次，。</p>
<p>到底这部分是怎么计算出来的呢？ß</p>
<p><a target="_blank" rel="noopener" href="https://f2.svbtle.com/ceph-block-performance-monitoring">Ceph
Block Performance Monitoring</a></p>
<p>the OSD-based statistical stats are the end solution since that can
never provide the latencies that the client is actually
experiencing.</p>
<p>这篇里提到这个链接，有点意思？</p>
<p><a target="_blank" rel="noopener" href="https://tracker.ceph.com/projects/ceph/wiki/Live_Performance_Probes">Live
Performance Probes - Ceph - Ceph</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/16071">mgr, rbd: report
rbd images perf stats to mgr by Yan-waller · Pull Request #16071 ·
ceph/ceph</a></p>
<p>(看这篇)</p>
<p>目前的怀疑点是在Nautilus的版本里在osd那层新增了不少埋点数据收集</p>
<p>这里提到了SLA（服务等级协议service level agreement)
（提问题的人说到了想要这种客户端级别的IOPSjiankong ）</p>
<blockquote>
<p>As we know, one perfcounter metric was created in ImageCtx when we
opened a rbd image , but these metrics data is scattered and reside in
kinds of clients, furthermore, a rbd image could be opened
simultaneously by more than one client. report these information
(especially ops, bytes, latency ) to MGR may be useful.</p>
</blockquote>
<blockquote>
<p>Ultimately, I still expect that operational indicators that we send
up to mgr will mostly get reported onwards to something else (nagios,
zabbix, snmp, etc), so for O(clients) monitoring jobs we should consider
skipping the middleman.</p>
</blockquote>
<p>这个@jcsp大佬推荐是在mgr的插件层完成这个监控的操作，然后实际上好像也的确完成了。support-rbd啊，osd-perf-count啊，都是基于ceph-mgr的插件。</p>
<blockquote>
<p>monitoring that gives them per-client throughput, latency and op type
breakdown, I'm not sure how strong the push would be to implement the
separate monitoring path to go get the client's view of the same set of
stats.</p>
</blockquote>
<p>待看<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/25358">mgr/prometheus:
provide RBD stats via osd dynamic perf counters by trociny · Pull
Request #25358 · ceph/ceph</a></p>
<p>在module.py里通过OSD_PERF_QUERY_COUNTERS_INDICES这个来把一个counter按照我们要的key导出数据。</p>
<p><code>extract_pool_key</code>是用来提取像<code>pool1/image0</code>这样的spec字符串里的pool
name的，</p>
<p><code>user_queries</code>到底是放了什么内容？</p>
<p><code>OSDPerfMetricCollectorListener</code>这个应该是才是真实被Ceph-mgr实例化的内容。、</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OSDPerfMetricCollectorListener</span> :</span><br><span class="line">     <span class="keyword">public</span> OSDPerfMetricCollector::Listener</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>DaemonServer</code>初始化的时候</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">osd_perf_metric_collector_listener</span>(<span class="keyword">this</span>),</span><br><span class="line">      <span class="built_in">osd_perf_metric_collector</span>(osd_perf_metric_collector_listener)</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">int</span> OSDPerfMetricQueryID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::pair&lt;<span class="type">uint64_t</span>,<span class="type">uint64_t</span>&gt; PerformanceCounter;</span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;PerformanceCounter&gt; PerformanceCounters;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PerformanceCounterDescriptor</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> PerformanceCounterType::OPS:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::WRITE_OPS:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::READ_OPS:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::BYTES:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::WRITE_BYTES:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::READ_BYTES:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::LATENCY:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::WRITE_LATENCY:</span><br><span class="line">    <span class="keyword">case</span> PerformanceCounterType::READ_LATENCY:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;std::string&gt; OSDPerfMetricSubKey; <span class="comment">// array of regex match</span></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;OSDPerfMetricSubKey&gt; OSDPerfMetricKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">OSDPerfMetricSubKeyType</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">  CLIENT_ID = <span class="number">0</span>,</span><br><span class="line">  CLIENT_ADDRESS = <span class="number">1</span>,</span><br><span class="line">  POOL_ID = <span class="number">2</span>,</span><br><span class="line">  NAMESPACE = <span class="number">3</span>,</span><br><span class="line">  OSD_ID = <span class="number">4</span>,</span><br><span class="line">  PG_ID = <span class="number">5</span>,</span><br><span class="line">  OBJECT_NAME = <span class="number">6</span>,</span><br><span class="line">  SNAP_ID = <span class="number">7</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>根据这里来看，果然是在Nautuil版本里，给ceph-mgr里增加了很多功能。
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">typedef</span> std::map&lt;OSDPerfMetricQueryID,</span><br><span class="line">                   std::map&lt;OSDPerfMetricKey, PerformanceCounters&gt;&gt; Counters;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">OSDPerfMetricCollector::get_counters</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OSDPerfMetricQueryID query_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::map&lt;OSDPerfMetricKey, PerformanceCounters&gt; *c)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DaemonServer::get_osd_perf_counters</span><span class="params">(</span></span></span><br></pre></td></tr></table></figure>
这里调用到<code>get_counter</code>.这个接口被封装进pybind里了。</p>
<p>这里面的数据都是从哪里手机的呢？这个collector只是作为一个接口层提供收集的函数，手机的内容是通过指针穿进去的。还是存在了DaemonServer这个类里。</p>
<p>这里面到底调用了什么接口来收集osd？
<code>OSDPerfMetricQueryID OSDPerfMetricCollector::add_query(</code>
在这个函数里添加的到底是任务，还是收集的值呢？应该是任务吧？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> std::map&lt;OSDPerfMetricQuery,</span><br><span class="line">                   std::map&lt;OSDPerfMetricQueryID, OptionalLimit&gt;&gt; Queries;</span><br></pre></td></tr></table></figure>
<p>这个和queries有什么关系呢？ <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">typedef</span> std::optional&lt;OSDPerfMetricLimit&gt; OptionalLimit;</span><br><span class="line">  <span class="keyword">typedef</span> std::map&lt;OSDPerfMetricQuery,</span><br><span class="line">                   std::map&lt;OSDPerfMetricQueryID, OptionalLimit&gt;&gt; Queries;</span><br><span class="line">  <span class="keyword">typedef</span> std::map&lt;OSDPerfMetricQueryID,</span><br><span class="line">                   std::map&lt;OSDPerfMetricKey, PerformanceCounters&gt;&gt; Counters;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OSDPerfMetricLimit</span> &#123;</span><br><span class="line">  PerformanceCounterDescriptor order_by;</span><br><span class="line">  <span class="type">uint64_t</span> max_count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>在<code>bool DaemonServer::handle_report(MMgrReport *m)</code>这个里
<code>osd_perf_metric_collector.process_reports(m-&gt;osd_perf_metric_reports);</code>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OSDPerfMetricCollectorListener</span> :</span><br><span class="line">    <span class="keyword">public</span> OSDPerfMetricCollector::Listener &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">OSDPerfMetricCollectorListener</span>(DaemonServer *server)</span><br><span class="line">    : <span class="built_in">server</span>(server) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handle_query_updated</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    server-&gt;<span class="built_in">handle_osd_perf_metric_query_updated</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure> 这里继承了Listener里的虚函数接口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DaemonServer::handle_osd_perf_metric_query_updated</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">dout</span>(<span class="number">10</span>) &lt;&lt; dendl;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send a fresh MMgrConfigure to all clients, so that they can follow</span></span><br><span class="line">  <span class="comment">// the new policy for transmitting stats</span></span><br><span class="line">  finisher.<span class="built_in">queue</span>(<span class="keyword">new</span> <span class="built_in">FunctionContext</span>([<span class="keyword">this</span>](<span class="type">int</span> r) &#123;</span><br><span class="line">        std::lock_guard <span class="built_in">l</span>(lock);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;c : daemon_connections) &#123;</span><br><span class="line">          <span class="keyword">if</span> (c-&gt;<span class="built_in">peer_is_osd</span>()) &#123;</span><br><span class="line">            _send_configure(c);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This message is sent from ceph-mgr to MgrClient, instructing it</span></span><br><span class="line"><span class="comment"> * it about what data to send back to ceph-mgr at what frequency.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MMgrConfigure</span> : <span class="keyword">public</span> MessageInstance&lt;MMgrConfigure&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/24180">mgr: update
MMgrConfigure message to include optional OSD perf queries by colletj ·
Pull Request #24180 · ceph/ceph</a></p>
<p>可能数据是从MgrClient里来的？嗯，忘了之前看过,
现在也才意识到mgr其实分成了Server和client，</p>
<p>osd和pg都看到了，但是其他的呢？如果只有这两个数据，那其他的rados那些是怎么算出来的？</p>
<p>set_perf_queries_cb(m-&gt;osd_perf_metric_queries);</p>
<p><a target="_blank" rel="noopener" href="http://blog.wjin.org/posts/ceph-manager-overview.html">Ceph
Manager Overview</a></p>
<p>这篇里主要讲的mgr的代码</p>
<blockquote>
<p>以osd
daemon为例，在启动过程中，会发送消息MMgrOpen，mgr收到后，会回复MMgrConfigure消息，主要是返回一个period时间，后续osd就根据设定的period，
定期将状态信息上报给mgr，即消息MMgrReport和MPGStats:</p>
</blockquote>
<p>本以为这段代码里不涉及image的信息了</p>
<p>但是下面这段查询到的数据里显然带上了rbd的image信息 <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">res = self.module.get_osd_perf_counters(query_id)</span><br><span class="line"><span class="keyword">for</span> counter <span class="keyword">in</span> res[<span class="string">&#x27;counters&#x27;</span>]:</span><br><span class="line">        raw_image[<span class="number">0</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> raw_image[<span class="number">0</span>]:</span><br><span class="line">        raw_image[<span class="number">0</span>] = [now_ts, [<span class="built_in">int</span>(x[<span class="number">0</span>]) <span class="keyword">for</span> x <span class="keyword">in</span> counter[<span class="string">&#x27;c&#x27;</span>]]]</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/29214">mgr: templatize
metrics collection interface by vshankar · Pull Request #29214 ·
ceph/ceph</a></p>
<p>这里做了一层封装模板化</p>
<p>blame</p>
<p>Daemon里的这个函数get_osd_perf_counters是下面这条里加的</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vshankar/ceph/commit/b8362d904a710c10ab72f15c78fdafc3ff21f020">mgr:
make dynamic osd perf counters accessible from modules ·
vshankar/ceph@b8362d9</a></p>
<p>get_counters这个实际工作的方法呢？</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vshankar/ceph/commit/438a3f7bc40c66b14b7f61959f8dd691ea0b5220">mgr:
store osd perf counters received in osd reports ·
vshankar/ceph@438a3f7</a></p>
<p>又没头绪了</p>
<p>还是回到prometheus这里使用上看看阿布</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/25358/files">mgr/prometheus:
provide RBD stats via osd dynamic perf counters by trociny · Pull
Request #25358 · ceph/ceph</a> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Per RBD image stats is collected by registering a dynamic osd perf</span></span><br><span class="line">      <span class="comment"># stats query that tells OSDs to group stats for requests associated</span></span><br><span class="line">      <span class="comment"># with RBD objects by pool, namespace, and image id, which are</span></span><br><span class="line">      <span class="comment"># extracted from the request object names or other attributes.</span></span><br><span class="line">      <span class="comment"># The RBD object names have the following prefixes:</span></span><br><span class="line">      <span class="comment">#   - rbd_data.&#123;image_id&#125;. (data stored in the same pool as metadata)</span></span><br><span class="line">      <span class="comment">#   - rbd_data.&#123;pool_id&#125;.&#123;image_id&#125;. (data stored in a dedicated data pool)</span></span><br><span class="line">      <span class="comment">#   - journal_data.&#123;pool_id&#125;.&#123;image_id&#125;. (journal if journaling is enabled)</span></span><br><span class="line">      <span class="comment"># The pool_id in the object name is the id of the pool with the image</span></span><br><span class="line">      <span class="comment"># metdata, and should be used in the image spec. If there is no pool_id</span></span><br><span class="line">      <span class="comment"># in the object name, the image pool is the pool where the object is</span></span><br><span class="line">      <span class="comment"># located.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;query_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> self.rbd_stats:</span><br><span class="line">          query = &#123;</span><br><span class="line">              <span class="string">&#x27;key_descriptor&#x27;</span>: [</span><br><span class="line">                  &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;pool_id&#x27;</span>, <span class="string">&#x27;regex&#x27;</span>: pool_id_regex&#125;,</span><br><span class="line">                  &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;namespace&#x27;</span>, <span class="string">&#x27;regex&#x27;</span>: namespace_regex&#125;,</span><br><span class="line">                  &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;object_name&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;regex&#x27;</span>: <span class="string">&#x27;^(?:rbd|journal)_data\.(?:([0-9]+)\.)?([^.]+)\.&#x27;</span>&#125;,</span><br><span class="line">              ],</span><br><span class="line">              <span class="string">&#x27;performance_counter_descriptors&#x27;</span>: <span class="built_in">list</span>(counters_info),</span><br><span class="line">          &#125;</span><br><span class="line">          query_id = self.add_osd_perf_query(query)</span><br><span class="line">          <span class="keyword">if</span> query_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">              self.log.error(<span class="string">&#x27;failed to add query %s&#x27;</span> % query)</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">          self.rbd_stats[<span class="string">&#x27;query&#x27;</span>] = query</span><br><span class="line">          self.rbd_stats[<span class="string">&#x27;query_id&#x27;</span>] = query_id</span><br><span class="line"></span><br><span class="line">      res = self.get_osd_perf_counters(self.rbd_stats[<span class="string">&#x27;query_id&#x27;</span>])</span><br></pre></td></tr></table></figure> 这段注释写的是真的好</p>
<p>所以其实还是这个借口的功能，类似mon_command，提供了根据传入的数据进行收集的操作。</p>
<p>这里也的确用上赋值逻辑</p>
<p>queryID到底是怎么期作用的？</p>
<p>来自<code>add_osd_perf_query</code></p>
<p>OSDPerfMetricQueryID DaemonServer::add_osd_perf_query(</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  query = &#123;</span><br><span class="line">    <span class="string">&#x27;key_descriptor&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;pool_id&#x27;</span>, <span class="string">&#x27;regex&#x27;</span>: pool_id_regex&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;namespace&#x27;</span>, <span class="string">&#x27;regex&#x27;</span>: namespace_regex&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;object_name&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;regex&#x27;</span>: <span class="string">&#x27;^(?:rbd|journal)_data\.(?:([0-9]+)\.)?([^.]+)\.&#x27;</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;performance_counter_descriptors&#x27;</span>: <span class="built_in">list</span>(counters_info),</span><br><span class="line">&#125;</span><br><span class="line">query_id = self.<span class="built_in">add_osd_perf_query</span>(query)</span><br></pre></td></tr></table></figure>
<p>使用上</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vshankar/ceph/commit/a6c3390834759e3f953962d46cc7c840c9970046">mgr:
create shell OSD performance query class · vshankar/ceph@a6c3390</a></p>
<p>这个<code>add_osd_perf_query</code>是在这里加的</p>
<p>add_query也是他家的。 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> PyObject*</span></span><br><span class="line"><span class="function"><span class="title">ceph_add_osd_perf_query</span><span class="params">(BaseMgrModule *self, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_KEY_DESCRIPTOR = <span class="string">&quot;key_descriptor&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_COUNTERS_DESCRIPTORS =</span><br><span class="line">      <span class="string">&quot;performance_counter_descriptors&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_LIMIT = <span class="string">&quot;limit&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_SUB_KEY_TYPE = <span class="string">&quot;type&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_SUB_KEY_REGEX = <span class="string">&quot;regex&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_LIMIT_ORDER_BY = <span class="string">&quot;order_by&quot;</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> std::string NAME_LIMIT_MAX_COUNT = <span class="string">&quot;max_count&quot;</span>;</span><br></pre></td></tr></table></figure> 在封装python这里做的参数解析
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> query_id = self-&gt;py_modules-&gt;<span class="built_in">add_osd_perf_query</span>(query, limit);</span><br></pre></td></tr></table></figure> 所有属性都传到了limit里</p>
<p>在_send_configure的时候，把limit里的任务传给了MgrClient
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">OSDPerfMetricLimit</span> &#123;</span><br><span class="line">  PerformanceCounterDescriptor order_by;</span><br><span class="line">  <span class="type">uint64_t</span> max_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OSDPerfMetricLimit</span>() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OSDPerfMetricLimit</span>(<span class="type">const</span> PerformanceCounterDescriptor &amp;order_by,</span><br><span class="line">                     <span class="type">uint64_t</span> max_count)</span><br><span class="line">    : <span class="built_in">order_by</span>(order_by), <span class="built_in">max_count</span>(max_count) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> OSDPerfMetricLimit &amp;other) <span class="type">const</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (order_by != other.order_by) &#123;</span><br><span class="line">      <span class="keyword">return</span> order_by &lt; other.order_by;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max_count &lt; other.max_count;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DENC</span>(OSDPerfMetricLimit, v, p) &#123;</span><br><span class="line">    <span class="built_in">DENC_START</span>(<span class="number">1</span>, <span class="number">1</span>, p);</span><br><span class="line">    <span class="built_in">denc</span>(v.order_by, p);</span><br><span class="line">    <span class="built_in">denc</span>(v.max_count, p);</span><br><span class="line">    <span class="built_in">DENC_FINISH</span>(p);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
传过去的应该是这个<code>OptionalLimit</code>吧，这个有啥用？</p>
<p>里面有个<code>order_by</code>里申明是哪种type,是pg还是rados了好像</p>
<p>encode之后发送到mgrclient</p>
<p>看看怎么解码</p>
<p>std::function&lt;void(const std::map&lt;OSDPerfMetricQuery,
OSDPerfMetricLimits&gt; &amp;)&gt; set_perf_queries_cb;</p>
<p>在这个<code>MgrClient.cc</code>里居然有2个<code>set_perf_queries_cb</code></p>
<p>一个是封装的MgrClient对外暴露的函数，就是用来赋值的？</p>
<p>一个是private的值，与mgr的Daemon沟通时进行调用。</p>
<p>但是这里好像只看到了osd.cc触发啊</p>
<p>这个被osd.cc里调用了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OSD::set_perf_queries</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::map&lt;OSDPerfMetricQuery, OSDPerfMetricLimits&gt; &amp;queries)</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>怎么看上去osd.cc里不止负责普通的osd信息收集</p>
<p>在12版本里，这个OSD.cc里也有mgrc</p>
<p>在14版本里， std::list<OSDPerfMetricQuery>
m_perf_queries;属于OSD这个class <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">set_perf_queries</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> std::map&lt;OSDPerfMetricQuery, OSDPerfMetricLimits&gt; &amp;queries)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">get_perf_reports</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      std::map&lt;OSDPerfMetricQuery, OSDPerfMetricReport&gt; *reports)</span></span>;</span><br><span class="line"></span><br><span class="line">  Mutex m_perf_queries_lock = &#123;<span class="string">&quot;OSD::m_perf_queries_lock&quot;</span>&#125;;</span><br><span class="line">  std::list&lt;OSDPerfMetricQuery&gt; m_perf_queries;</span><br><span class="line">  std::map&lt;OSDPerfMetricQuery, OSDPerfMetricLimits&gt; m_perf_limits;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">get_perf_reports</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      std::map&lt;OSDPerfMetricQuery, OSDPerfMetricReport&gt; *reports)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  mgrc.<span class="built_in">set_pgstats_cb</span>([<span class="keyword">this</span>]()&#123; <span class="keyword">return</span> <span class="built_in">collect_pg_stats</span>(); &#125;);</span><br><span class="line">  mgrc.<span class="built_in">set_perf_metric_query_cb</span>(</span><br><span class="line">    [<span class="keyword">this</span>](<span class="type">const</span> std::map&lt;OSDPerfMetricQuery, OSDPerfMetricLimits&gt; &amp;queries) &#123;</span><br><span class="line">        <span class="built_in">set_perf_queries</span>(queries);</span><br><span class="line">      &#125;,</span><br><span class="line">      [<span class="keyword">this</span>](std::map&lt;OSDPerfMetricQuery, OSDPerfMetricReport&gt; *reports) &#123;</span><br><span class="line">        <span class="built_in">get_perf_reports</span>(reports);</span><br><span class="line">      &#125;);</span><br><span class="line">  mgrc.<span class="built_in">init</span>();</span><br></pre></td></tr></table></figure></OSDPerfMetricQuery></p>
<p>osd把收集pg信息的回调函数设置到mgrc里,接下来应该是由mgrc来调用了把</p>
<p>在<code>void MgrClient::_send_report()</code>这里会触发调用.</p>
<p>理论上应该是</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OSD::get_perf_reports</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    std::map&lt;OSDPerfMetricQuery, OSDPerfMetricReport&gt; *reports)</span> </span>&#123;</span><br><span class="line">  std::vector&lt;PGRef&gt; pgs;</span><br><span class="line">  _get_pgs(&amp;pgs);</span><br><span class="line">  DynamicPerfStats dps;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; pg : pgs) &#123;</span><br><span class="line">    <span class="comment">// m_perf_queries can be modified only in set_perf_queries by mgr client</span></span><br><span class="line">    <span class="comment">// request, and it is protected by by mgr client&#x27;s lock, which is held</span></span><br><span class="line">    <span class="comment">// when set_perf_queries/get_perf_reports are called, so we may not hold</span></span><br><span class="line">    <span class="comment">// m_perf_queries_lock here.</span></span><br><span class="line">    <span class="function">DynamicPerfStats <span class="title">pg_dps</span><span class="params">(m_perf_queries)</span></span>;</span><br><span class="line">    pg-&gt;<span class="built_in">lock</span>();</span><br><span class="line">    pg-&gt;<span class="built_in">get_dynamic_perf_stats</span>(&amp;pg_dps);</span><br><span class="line">    pg-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">    dps.<span class="built_in">merge</span>(pg_dps);</span><br><span class="line">  &#125;</span><br><span class="line">  dps.<span class="built_in">add_to_reports</span>(m_perf_limits, reports);</span><br><span class="line">  <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; <span class="string">&quot;reports for &quot;</span> &lt;&lt; reports-&gt;<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; queries&quot;</span> &lt;&lt; dendl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>void add_to_reports(</p>
<p>下面这个数据在primary_log的里 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimaryLogPG</span> : <span class="keyword">public</span> PG, <span class="keyword">public</span> PGBackend::Listener &#123;</span><br><span class="line"></span><br><span class="line">  DynamicPerfStats m_dynamic_perf_stats;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrimaryLogPG::get_dynamic_perf_stats</span><span class="params">(DynamicPerfStats *stats)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">std::swap</span><span class="params">(m_dynamic_perf_stats, *stats)</span></span>;</span><br></pre></td></tr></table></figure>
而这个value在下面这里更新的 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrimaryLogPG::log_op_stats</span><span class="params">(<span class="type">const</span> OpRequest&amp; op,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    m_dynamic_perf_stats.add(osd, info, op, inb, outb, latency);</span></span></span><br></pre></td></tr></table></figure>
差别可能真在这?在12版本的这个<code>log_op_stats</code>函数里,没有记录perf信息的.
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">          <span class="keyword">auto</span> m = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> MOSDOp*&gt;(op.<span class="built_in">get_req</span>());</span><br><span class="line">std::string match_string;</span><br><span class="line">          <span class="keyword">switch</span>(d.type) &#123;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::CLIENT_ID:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(m-&gt;<span class="built_in">get_reqid</span>().name);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::CLIENT_ADDRESS:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(m-&gt;<span class="built_in">get_connection</span>()-&gt;<span class="built_in">get_peer_addr</span>());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::POOL_ID:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(m-&gt;<span class="built_in">get_spg</span>().<span class="built_in">pool</span>());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::NAMESPACE:</span><br><span class="line">            match_string = m-&gt;<span class="built_in">get_hobj</span>().nspace;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::OSD_ID:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(osd-&gt;<span class="built_in">get_nodeid</span>());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::PG_ID:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(pg_info.pgid);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::OBJECT_NAME:</span><br><span class="line">            match_string = m-&gt;<span class="built_in">get_oid</span>().name;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OSDPerfMetricSubKeyType::SNAP_ID:</span><br><span class="line">            match_string = <span class="built_in">stringify</span>(m-&gt;<span class="built_in">get_snapid</span>());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">ceph_abort_msg</span>(<span class="string">&quot;unknown counter type&quot;</span>);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
的确是在这个add这里加的,奇怪了.这里的<code>m</code>是怎么拿到所谓的snapobject这些信息的呢?
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">          <span class="keyword">auto</span> m = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> MOSDOp*&gt;(op.<span class="built_in">get_req</span>());</span><br><span class="line"></span><br><span class="line">Requests are MOSDOp messages.  Replies are MOSDOpReply messages.</span><br><span class="line"></span><br><span class="line">An object request is targeted at an <span class="type">hobject_t</span>, which includes a pool,</span><br><span class="line">hash value, object name, <span class="function">placement <span class="title">key</span> <span class="params">(usually empty)</span>, <span class="keyword">and</span> snapid.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">The hash value is a 32-bit hash value, normally generated by hashing</span></span><br><span class="line"><span class="function">the object name.  The <span class="type">hobject_t</span> can be arbitrarily constructed,</span></span><br><span class="line"><span class="function">though, with any hash value <span class="keyword">and</span> name.  Note that in the MOSDOp these</span></span><br><span class="line"><span class="function">components are spread across several fields <span class="keyword">and</span> <span class="keyword">not</span> logically</span></span><br><span class="line"><span class="function">assembled in an actual <span class="type">hobject_t</span> <span class="title">member</span> <span class="params">(mainly historical reasons)</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">A request can also target a PG.  In <span class="keyword">this</span> <span class="keyword">case</span>, the *ps* value matches</span></span><br><span class="line"><span class="function">a specific PG, the object name is empty, <span class="title">and</span> <span class="params">(hopefully)</span> the ops in</span></span><br><span class="line"><span class="function">the request are PG ops.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Either way, the request ultimately targets a PG, either by <span class="keyword">using</span> the</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> pgid <span class="keyword">or</span> by folding the hash value onto the current number of</span></span><br><span class="line"><span class="function">pgs in the pool.  The client sends the request to the primary <span class="keyword">for</span> the</span></span><br><span class="line"><span class="function">associated PG.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Each request is assigned a unique tid.</span></span><br></pre></td></tr></table></figure> 原来这里是osd的落盘请求链路,这里能通过req()
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MOSDOp</span> : <span class="keyword">public</span> MessageInstance&lt;MOSDOp, MOSDFastDispatchOp&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  std::map&lt;OSDPerfMetricQuery,</span><br><span class="line">           std::map&lt;OSDPerfMetricKey, PerformanceCounters&gt;&gt; data;</span><br></pre></td></tr></table></figure> <a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/24265/files#">osd: collect
client perf stats when query is enabled by trociny · Pull Request #24265
· ceph/ceph</a></p>
<p>找到了,是在这个pr里增加的数据收集,
又是<code>trociny</code>这个大佬提交的.</p>
<p>ceph tell mgr osd perf query add simple the mgr starts to receive
perf report, writing to the log:</p>
<p>简单点说原理是在osd的最下层通过request的MOSDop这个类,查到这次request各层的名字,然后在对应的计数器数加一
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrimaryLogPG::log_op_stats</span><span class="params">(<span class="type">const</span> OpRequest&amp; op,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">const</span> <span class="type">uint64_t</span> inb,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="type">const</span> <span class="type">uint64_t</span> outb)</span></span></span><br></pre></td></tr></table></figure> 在这的时候传入的op.</p>
<p>这个DynamicPerfStats.h的文件是在osd目录里.</p>
<pre><code>dps.merge(pg_dps);</code></pre>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2023-03-18T15:11:14.895Z" itemprop="dateUpdated">2023-03-18 23:11:14</time>
</span><br>


        
        欢迎评论~
        
    </div>
    
    <footer>
        <a href="https://sean10.github.io">
            <img src="/img/avatar.jpg" alt="Sean10">
            Sean10
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ceph/" rel="tag">ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rbd/" rel="tag">rbd</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>


            
<!-- Go to www.addthis.com/dashboard to customize your tools --> 
<div class="addthis_sharing_toolbox"></div>
            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&title=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&pic=https://sean10.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&title=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&source=笔记 随笔" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&via=https://sean10.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2020/07/11/mac%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E8%B8%A9%E5%9D%91/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">mac远程桌面踩坑</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2020/07/04/ceph%E4%B9%8Btier%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">ceph之tier数据源码初探</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <!-- <script src="//code.bdstatic.com/npm/leancloud-storage@latest/dist/av-min.js"></script> -->
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'true' == 'true',
            verify: 'false' == 'true',
            appId: "yNexbxJmshSneppnaoo3Bd6Y-gzGzoHsz",
            appKey: "FyxT8MxDPHbu8mQSapgjEMPC",
            avatar: "mm",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->










</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>




        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Sean10 &copy; 2015 - 2023</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&title=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&pic=https://sean10.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&title=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&source=笔记 随笔" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《ceph之Nautilus版本引入的Perf统计》 — 行路中.&url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/&via=https://sean10.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://sean10.github.io/2020/07/06/ceph%E4%B9%8BNautilus%E7%89%88%E6%9C%AC%E5%BC%95%E5%85%A5%E7%9A%84Perf%E7%BB%9F%E8%AE%A1/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<!-- Go to www.addthis.com/dashboard to customize your tools --> 
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57108c0b91bea817"></script>

<script src="/js/main.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</body>
</html>
