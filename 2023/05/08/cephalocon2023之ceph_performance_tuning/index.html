<!DOCTYPE html>
<html>
<head>
    

    

    



    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    
    
    
    
    <title>cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH | 行路中. | 脚踏实地</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="ceph,cephalocon">
    <meta name="description" content="Ceph Performance Tuning: From Bluestore to RBD - Mark Nelson, Clyso GmbH - YouTube Mark Nelson: Performance &#x2F; CBT模块成员 推荐性能优化时使用工具 当前性能测试, 60个osd, 450W 随机4K读, 平均75K每个osd.  硬件性能如何很关键, 测试过程中升级驱动解决了nvme Q">
<meta property="og:type" content="article">
<meta property="og:title" content="cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH">
<meta property="og:url" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/index.html">
<meta property="og:site_name" content="行路中.">
<meta property="og:description" content="Ceph Performance Tuning: From Bluestore to RBD - Mark Nelson, Clyso GmbH - YouTube Mark Nelson: Performance &#x2F; CBT模块成员 推荐性能优化时使用工具 当前性能测试, 60个osd, 450W 随机4K读, 平均75K每个osd.  硬件性能如何很关键, 测试过程中升级驱动解决了nvme Q">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515222026337.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515221944597.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515222236661.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515223230217.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225613901.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225758658.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225852139.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225941620.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230134777.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230219222.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230402733.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230716172.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515231529585.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515231753863.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232152813.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232734740.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232835377.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515233244520.png">
<meta property="og:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515233426305.png">
<meta property="article:published_time" content="2023-05-08T13:09:38.000Z">
<meta property="article:modified_time" content="2023-06-05T15:48:44.969Z">
<meta property="article:author" content="Sean10">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="cephalocon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515222026337.png">
    
        <link rel="alternate" type="application/atom+xml" title="行路中." href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 6.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Sean10</h5>
          <a href="mailto:sean10reborn@gmail.com" title="sean10reborn@gmail.com" class="mail">sean10reborn@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/sean10" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH</h1>
        <h5 class="subtitle">
            
                <time datetime="2023-05-08T13:09:38.000Z" itemprop="datePublished" class="page-time">
  2023-05-08
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pro/">专业</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ceph-performance-tuning-from-bluestore-to-rbd---mark-nelson-clyso-gmbh---youtube"><span class="post-toc-number">1.</span> <span class="post-toc-text">Ceph
Performance Tuning: From Bluestore to RBD - Mark Nelson, Clyso GmbH -
YouTube</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8E%A8%E8%8D%90%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%97%B6%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="post-toc-number">1.0.1.</span> <span class="post-toc-text">推荐性能优化时使用工具</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%BD%93%E5%89%8D%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95-60%E4%B8%AAosd-450w-%E9%9A%8F%E6%9C%BA4k%E8%AF%BB-%E5%B9%B3%E5%9D%8775k%E6%AF%8F%E4%B8%AAosd."><span class="post-toc-number">1.0.2.</span> <span class="post-toc-text">当前性能测试,
60个osd, 450W 随机4K读, 平均75K每个osd.</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%A1%AC%E4%BB%B6%E6%80%A7%E8%83%BD%E5%A6%82%E4%BD%95%E5%BE%88%E5%85%B3%E9%94%AE-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8D%87%E7%BA%A7%E9%A9%B1%E5%8A%A8%E8%A7%A3%E5%86%B3%E4%BA%86nvme-q8%E6%8C%81%E7%BB%AD%E8%BF%90%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B3%A2%E5%8A%A8%E6%98%BE%E8%91%97%E4%B8%8B%E9%99%8D%E9%97%AE%E9%A2%98"><span class="post-toc-number">1.0.3.</span> <span class="post-toc-text">硬件性能如何很关键,
测试过程中升级驱动解决了nvme Q8持续运行性能波动显著下降问题</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#pg%E6%95%B0%E9%87%8F%E5%AF%B9%E6%80%A7%E8%83%BD%E5%BD%B1%E5%93%8D"><span class="post-toc-number">1.0.4.</span> <span class="post-toc-text">pg数量对性能影响</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E9%9A%8F%E6%9C%BA%E8%AF%BB-%E6%AF%8F%E4%B8%AAosd-8192360409.6%E4%B8%AApg-%E7%9B%B8%E6%AF%94%E6%AD%A3%E5%B8%B8%E7%90%86%E8%A7%A3%E9%87%8C%E7%9A%84100-%E5%B7%AE%E6%8C%BA%E5%A4%9A%E7%9A%84"><span class="post-toc-number">1.0.4.1.</span> <span class="post-toc-text">随机读,
每个osd 8192*3&#x2F;60&#x3D;409.6个pg, 相比正常理解里的100,
差挺多的</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%86%99-%E6%AF%8F%E4%B8%AAosd2048360102.4-%E5%80%92%E6%98%AF%E6%AD%A3%E5%B8%B8"><span class="post-toc-number">1.0.4.2.</span> <span class="post-toc-text">随机写,
每个osd2048*3&#x2F;60&#x3D;102.4 , 倒是正常</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88pg%E6%95%B0%E9%87%8F%E6%9C%89%E6%95%88"><span class="post-toc-number">1.0.5.</span> <span class="post-toc-text">为什么pg数量有效?</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%A6%82pg%E4%BA%89%E7%94%A8%E6%98%AFpg%E6%95%B0%E5%A4%96%E5%BD%B1%E5%93%8D%E6%80%A7%E8%83%BD%E7%9A%84%E4%B8%80%E7%82%B9"><span class="post-toc-number">1.0.6.</span> <span class="post-toc-text">如pg争用是pg数外影响性能的一点</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%85%B6%E4%BB%96%E6%9C%89%E8%B6%A3%E7%9A%84%E6%A0%B7%E4%BE%8B"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">其他有趣的样例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#cephfs%E5%9C%A8%E5%A4%9Amds-%E9%80%9A%E8%BF%87%E5%8A%A8%E6%80%81%E5%AD%90%E6%A0%91%E5%88%86%E5%8C%BA%E5%BE%97%E5%88%B0%E4%BA%86%E4%B8%8D%E9%94%99%E7%9A%84%E6%95%88%E6%9E%9C"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">cephfs在多mds,
通过动态子树分区得到了不错的效果</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#rbd-snap-trimming"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">RBD Snap Trimming</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#osd-threading"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">OSD Threading</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#pglogrocksdb-interaction"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">PGLog&#x2F;RocksDB Interaction</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E9%92%88%E5%AF%B9kv-sync-%E6%88%91%E4%BB%AC%E6%9C%9F%E6%9C%9B%E5%B0%BD%E5%8F%AF%E8%83%BD%E5%B0%8F%E7%9A%84memtable%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E7%9A%84%E8%B7%B3%E8%A1%A8-%E5%87%8F%E5%B0%91%E6%AD%A4%E6%97%B6rocksdb%E4%B8%BA%E4%BA%86%E4%BF%9D%E5%BA%8F%E6%B6%88%E8%80%97%E7%9A%84%E5%A4%A7%E9%87%8Fcpu"><span class="post-toc-number">1.1.4.0.1.</span> <span class="post-toc-text">针对kv
sync, 我们期望尽可能小的memtable(内部实现的跳表),
减少此时rocksdb为了保序消耗的大量cpu,</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E9%92%88%E5%AF%B9pg-log%E5%86%99%E5%85%A5%E5%88%B0rocksdb-head-log-pg-log%E6%9C%AC%E8%BA%AB%E6%98%AF%E6%9C%9F%E6%9C%9B%E5%B0%BD%E5%8F%AF%E8%83%BD%E7%9F%AD%E5%AD%98%E5%9C%A8%E7%9A%84%E4%B8%80%E4%B8%AA%E4%B8%9C%E8%A5%BF-%E6%88%91%E4%BB%AC%E4%B8%8D%E6%9C%9F%E6%9C%9B%E8%A7%A6%E5%8F%91rocksdb%E7%9A%84compact%E8%A2%AB%E5%8E%8B%E7%BC%A9-%E5%9B%A0%E6%AD%A4%E6%9C%9F%E6%9C%9B%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E8%B6%8A%E5%A4%A7%E8%B6%8A%E5%A5%BD-%E4%BD%BF%E7%94%A8%E4%BA%86big-buffer-%E6%9C%9F%E6%9C%9B%E5%9C%A8flush-memtable%E6%97%B6-%E8%BF%99%E4%BA%9Bpg-log%E5%B7%B2%E7%BB%8F%E8%A2%AB%E6%A0%87%E6%B3%A8tombstone-%E5%B7%B2%E7%BB%8F%E5%8F%AF%E4%BB%A5%E5%88%A0%E9%99%A4-%E6%97%A0%E9%9C%80%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93.-%E6%97%A0%E9%9C%80%E8%90%BD%E7%9B%98"><span class="post-toc-number">1.1.4.0.2.</span> <span class="post-toc-text">针对pg
log写入到rocksdb head log, pg log本身是期望尽可能短存在的一个东西,
我们不期望触发rocksdb的compact被压缩, 因此期望内存使用越大越好,
使用了big buffer, 期望在flush memtable时, 这些pg log已经被标注tombstone,
已经可以删除, 无需写入数据库. 无需落盘</span></a></li></ol></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#bluestore-wal-prototype"><span class="post-toc-number">1.1.4.1.</span> <span class="post-toc-text">bluestore WAL prototype</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#rocksdb-tombstones"><span class="post-toc-number">1.1.5.</span> <span class="post-toc-text">RocksDB Tombstones</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#range-deletion-%E4%BB%85%E9%9C%80%E8%A6%81%E4%B8%80%E6%AC%A1%E5%88%A0%E9%99%A4%E5%A4%A7%E9%87%8F%E5%9C%BA%E6%99%AF%E4%B8%8B%E6%9C%89%E6%95%88-4-5%E5%B9%B4%E5%89%8D%E5%AE%9E%E9%AA%8C%E6%97%B6%E6%95%88%E6%9E%9C%E4%B8%8D%E5%A5%BD-%E5%90%AC%E8%AF%B4%E6%9C%80%E8%BF%91%E6%9C%89%E6%94%B9%E8%BF%9B-%E8%BF%98%E6%B2%A1%E5%85%B3%E6%B3%A8"><span class="post-toc-number">1.1.5.1.</span> <span class="post-toc-text">range
deletion 仅需要一次删除大量场景下有效, 4-5年前实验时效果不好,
听说最近有改进, 还没关注</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E9%99%90%E5%88%B6%E6%90%9C%E7%B4%A2%E5%92%8C%E6%89%AB%E6%8F%8F%E8%8C%83%E5%9B%B4-%E7%9B%AE%E5%89%8D%E4%BD%BF%E7%94%A8%E6%9C%89%E6%95%88"><span class="post-toc-number">1.1.5.2.</span> <span class="post-toc-text">限制搜索和扫描范围,
目前使用有效</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%BC%BA%E5%88%B6%E5%91%A8%E6%9C%9F%E5%8E%8B%E7%BC%A9sst-%E5%AF%B9%E7%A3%81%E7%9B%98%E5%8E%8B%E5%8A%9B%E5%A4%A7-%E4%B8%94%E5%AD%98%E5%9C%A8%E5%BC%95%E8%B5%B7%E5%BF%83%E8%B7%B3%E8%B6%85%E6%97%B6%E9%A3%8E%E9%99%A9.-mark%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8Fpr-wip-kvrocksdbstore-improved-rocksdb-settings-and-tombstone-behavior-by-markhpc-pull-request-47221-cephceph"><span class="post-toc-number">1.1.5.3.</span> <span class="post-toc-text">强制周期压缩sst,
对磁盘压力大, 且存在引起心跳超时风险. mark开发的一个小PR [WIP]
kv&#x2F;RocksDBStore: Improved RocksDB Settings and Tombstone behavior by
markhpc · Pull Request #47221 · ceph&#x2F;ceph</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#%E5%9C%A8digital-ocean%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD-%E5%AF%B9%E5%BB%B6%E6%97%B6%E6%9C%89%E4%BA%86%E6%9E%81%E5%A4%A7%E7%9A%84%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C."><span class="post-toc-number">1.1.5.3.1.</span> <span class="post-toc-text">在Digital
Ocean使用过程中, 对延时有了极大的优化效果.</span></a></li></ol></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#david-orman%E5%9B%A2%E9%98%9F%E5%9C%A8%E4%BA%91%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%BA%86%E4%B8%80%E4%B8%AA%E9%9D%9E%E5%B8%B8%E5%A4%A7%E7%9A%84%E9%9B%86%E7%BE%A4-%E4%BD%BF%E7%94%A8%E4%BA%86rocksdb%E7%9A%84ttl%E6%9D%A5%E4%BD%BF%E7%94%A8%E5%88%9A%E6%89%8D%E9%82%A3%E4%B8%AApatch-%E7%A3%81%E7%9B%98%E5%88%A9%E7%94%A8%E7%8E%87%E4%BB%8E90-95%E4%B8%8B%E9%99%8D%E5%88%B020-25"><span class="post-toc-number">1.1.5.4.</span> <span class="post-toc-text">David
Orman团队在云上运行了一个非常大的集群,
使用了rocksdb的TTL来使用刚才那个patch,
磁盘利用率从90-95%下降到20-25%</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93"><span class="post-toc-number">1.1.6.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8F%90%E9%97%AE"><span class="post-toc-number">1.1.7.</span> <span class="post-toc-text">提问</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%B0%83%E4%BC%98%E6%8E%A7%E5%88%B6memtables-size-%E6%98%AF%E5%90%A6%E6%9C%89%E5%8A%A9%E4%BA%8Epglogrocksdb-interaction%E9%97%AE%E9%A2%98"><span class="post-toc-number">1.1.7.1.</span> <span class="post-toc-text">自动化调优控制memtables
size 是否有助于PGLog&#x2F;RocksDB Interaction问题?</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%A3%80%E6%B5%8B%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%A0%E7%9A%84%E5%9D%97%E8%AE%BE%E5%A4%87%E4%BC%9A%E5%BC%80%E5%A7%8B%E6%8B%96%E7%B4%AF%E4%BD%A0%E7%9A%84%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E6%98%AF%E5%90%A6%E6%9C%89%E5%B8%AE%E5%8A%A9"><span class="post-toc-number">1.1.7.2.</span> <span class="post-toc-text">检测什么时候你的块设备会开始拖累你的集群性能是否有帮助?</span></a></li></ol></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-cephalocon2023之ceph_performance_tuning"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH</h1>
        <div class="post-meta">
            <time class="post-time" title="2023-05-08 21:09:38" datetime="2023-05-08T13:09:38.000Z"  itemprop="datePublished">2023-05-08</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pro/">专业</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2
id="ceph-performance-tuning-from-bluestore-to-rbd---mark-nelson-clyso-gmbh---youtube"><a
target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7D5Bgd5TuYw&amp;list=PLrBUGiINAakPd9nuoorqeOuS9P9MTWos3&amp;index=37">Ceph
Performance Tuning: From Bluestore to RBD - Mark Nelson, Clyso GmbH -
YouTube</a></h2>
<p>Mark Nelson: Performance / CBT模块成员</p>
<h4 id="推荐性能优化时使用工具">推荐性能优化时使用工具</h4>
<h4
id="当前性能测试-60个osd-450w-随机4k读-平均75k每个osd.">当前性能测试,
60个osd, 450W 随机4K读, 平均75K每个osd.</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515222026337.png" class="">
<h4
id="硬件性能如何很关键-测试过程中升级驱动解决了nvme-q8持续运行性能波动显著下降问题">硬件性能如何很关键,
测试过程中升级驱动解决了nvme Q8持续运行性能波动显著下降问题</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515221944597.png" class="">
<h4 id="pg数量对性能影响">pg数量对性能影响</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515222236661.png" class="">
<h5
id="随机读-每个osd-8192360409.6个pg-相比正常理解里的100-差挺多的">随机读,
每个osd <code>8192*3/60=409.6</code>个pg, 相比正常理解里的100,
差挺多的</h5>
<h5 id="随机写-每个osd2048360102.4-倒是正常">随机写,
每个osd<code>2048*3/60=102.4</code> , 倒是正常</h5>
<h4 id="为什么pg数量有效">为什么pg数量有效?</h4>
<p>pg数少时的效果似乎与蒙特卡洛算法有关?</p>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515223230217.png" class="">
<blockquote>
<p>Random distributions look clumpy at low samples counts. Higher PG
counts results in a more even workload and data distribution across
OSDs. The new primary workload balancer being developed by Josh Salomon
and Laura Flores will attempt to improve the distribution even at low PG
counts.</p>
<p>Is distribution quality the only explanation for the performance
differences though?</p>
</blockquote>
<p>主pg的均衡, 有助于在pg数少时提高性能.</p>
<h4
id="如pg争用是pg数外影响性能的一点">如pg争用是pg数外影响性能的一点</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225613901.png" class="">
<h3 id="其他有趣的样例">其他有趣的样例</h3>
<h4 id="cephfs在多mds-通过动态子树分区得到了不错的效果">cephfs在多mds,
通过动态子树分区得到了不错的效果</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225758658.png" class="">
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225852139.png" class="">
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515225941620.png" class="">
<h4 id="rbd-snap-trimming">RBD Snap Trimming</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230134777.png" class="">
<p>似乎是在shared-blob上做了一些努力, 碎片整理等?
以及不用遍历所有的元数据了.</p>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230219222.png" class="">
<h4 id="osd-threading">OSD Threading</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230402733.png" class="">
<blockquote>
<p>Why does performance level off, then drop, as the number of threads
per shard increases? A key point is that there is only 1 messenger
thread in this test. With more messenger threads, the effect
diminishes.</p>
<p>shard_lock contention? Possibly. We might spend too much time in
notify_one / notify_all with relation to the wait_lock. More testing
needed.</p>
</blockquote>
<p>主要是msgr线程数也需要考虑匹配. 具体原因还需要更多实验.</p>
<h4 id="pglogrocksdb-interaction">PGLog/RocksDB Interaction</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515230716172.png" class="">
<p>主要集中在下述2个场景, 针对2个的冲突, 修改了一些rocksdb逻辑,
会在reef版本上车.</p>
<h6
id="针对kv-sync-我们期望尽可能小的memtable内部实现的跳表-减少此时rocksdb为了保序消耗的大量cpu">针对kv
sync, 我们期望尽可能小的memtable(内部实现的跳表),
减少此时rocksdb为了保序消耗的大量cpu,</h6>
<h6
id="针对pg-log写入到rocksdb-head-log-pg-log本身是期望尽可能短存在的一个东西-我们不期望触发rocksdb的compact被压缩-因此期望内存使用越大越好-使用了big-buffer-期望在flush-memtable时-这些pg-log已经被标注tombstone-已经可以删除-无需写入数据库.-无需落盘">针对pg
log写入到rocksdb head log, pg log本身是期望尽可能短存在的一个东西,
我们不期望触发rocksdb的compact被压缩, 因此期望内存使用越大越好,
使用了big buffer, 期望在flush memtable时, 这些pg log已经被标注tombstone,
已经可以删除, 无需写入数据库. 无需落盘</h6>
<h5 id="bluestore-wal-prototype">bluestore WAL prototype</h5>
<p>期望能达成无需使用rocksdb的 head log, 初步看到效果单OSD 12W
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515231529585.png" class=""></p>
<h4 id="rocksdb-tombstones">RocksDB Tombstones</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515231753863.png" class="">
<p>可能会出现一个情况, 由于迭代大量的删除墓碑, 可能导致osd 心跳超时</p>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232152813.png" class="">
<h5
id="range-deletion-仅需要一次删除大量场景下有效-4-5年前实验时效果不好-听说最近有改进-还没关注">range
deletion 仅需要一次删除大量场景下有效, 4-5年前实验时效果不好,
听说最近有改进, 还没关注</h5>
<h5 id="限制搜索和扫描范围-目前使用有效">限制搜索和扫描范围,
目前使用有效</h5>
<h5
id="强制周期压缩sst-对磁盘压力大-且存在引起心跳超时风险.-mark开发的一个小pr-wip-kvrocksdbstore-improved-rocksdb-settings-and-tombstone-behavior-by-markhpc-pull-request-47221-cephceph">强制周期压缩sst,
对磁盘压力大, 且存在引起心跳超时风险. mark开发的一个小PR <a
target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/47221/files">[WIP]
kv/RocksDBStore: Improved RocksDB Settings and Tombstone behavior by
markhpc · Pull Request #47221 · ceph/ceph</a></h5>
<p>逻辑比较简单, 只是迭代过程中, 看到一定数量的墓碑,
然后设置了强制压缩条件, 则触发压缩.</p>
<h6 id="在digital-ocean使用过程中-对延时有了极大的优化效果.">在Digital
Ocean使用过程中, 对延时有了极大的优化效果.</h6>
<p>这个图片是DO提供的, 看延时应该是个非常大压力的hdd集群, 60s 延时</p>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232734740.png" class="">
<h5
id="david-orman团队在云上运行了一个非常大的集群-使用了rocksdb的ttl来使用刚才那个patch-磁盘利用率从90-95下降到20-25">David
Orman团队在云上运行了一个非常大的集群,
使用了rocksdb的TTL来使用刚才那个patch,
磁盘利用率从90-95%下降到20-25%</h5>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515232835377.png" class="">
<h4 id="总结">总结</h4>
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515233244520.png" class="">
<img src="/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/image-20230515233426305.png" class="">
<h4 id="提问">提问</h4>
<h5
id="自动化调优控制memtables-size-是否有助于pglogrocksdb-interaction问题">自动化调优控制memtables
size 是否有助于PGLog/RocksDB Interaction问题?</h5>
<p>只修改memtable size 会导致性能下降</p>
<p>但是如果配合同时修改level 0/1等的size大小到恰当好处,
即从memtable-&gt;level0-&gt;level1控制的很好, 效果应该会很好,
但是这个场景很复杂. 我们后续可以考虑.</p>
<h5
id="检测什么时候你的块设备会开始拖累你的集群性能是否有帮助">检测什么时候你的块设备会开始拖累你的集群性能是否有帮助?</h5>
<p>确实有帮助, 值得做.</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2023-06-05T15:48:44.969Z" itemprop="dateUpdated">2023-06-05 23:48:44</time>
</span><br>


        
        欢迎评论~
        
    </div>
    
    <footer>
        <a href="https://sean10.github.io">
            <img src="/img/avatar.jpg" alt="Sean10">
            Sean10
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ceph/" rel="tag">ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cephalocon/" rel="tag">cephalocon</a></li></ul>


            
<!-- Go to www.addthis.com/dashboard to customize your tools --> 
<div class="addthis_sharing_toolbox"></div>
            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&title=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&pic=https://sean10.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&title=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&source=笔记 随笔" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&via=https://sean10.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2023/06/05/cephalocon2023%E4%B9%8Bbluestore-v2/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">(施工中)cephalocon2023之bluestore_v2</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2023/03/22/ceph%E4%B9%8Bpurged-snaps%E5%A4%9A%E5%9C%BA%E6%99%AF%E4%B8%8B%E9%97%AE%E9%A2%98/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">ceph之L版本purged_snaps过多问题</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <!-- <script src="//code.bdstatic.com/npm/leancloud-storage@latest/dist/av-min.js"></script> -->
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'true' == 'true',
            verify: 'false' == 'true',
            appId: "yNexbxJmshSneppnaoo3Bd6Y-gzGzoHsz",
            appKey: "FyxT8MxDPHbu8mQSapgjEMPC",
            avatar: "mm",
            placeholder: "Just go go",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->










</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>




        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Sean10 &copy; 2015 - 2025</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&title=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&pic=https://sean10.github.io/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&title=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&source=笔记 随笔" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《cephalocon2023之ceph performance tuning:from bluestore to rbd -Mark Nelson, Clyso GmbH》 — 行路中.&url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/&via=https://sean10.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://sean10.github.io/2023/05/08/cephalocon2023%E4%B9%8Bceph_performance_tuning/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<!-- Go to www.addthis.com/dashboard to customize your tools --> 
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57108c0b91bea817"></script>

<script src="/js/main.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.js?v=1.7.2" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>




<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</body>
</html>
